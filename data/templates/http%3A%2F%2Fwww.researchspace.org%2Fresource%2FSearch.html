<div id="structured-search">
<ol class="page-breadcrumb">
  <li class="active">Structured Search</li>
</ol>
 <!-- //TODO improve performance, check components & times -->
[[> rsp:SearchEventProxies]]
<div class="page">
  [[#>rsp:ClipboardSidebar]]
  <div class="page__body--borderless">
    <semantic-search
      id="semantic-search"
      limit="50000"
      optimizer="blazegraph"
      categories='[[> rsp:SearchCategories]]'
      search-profile='[[> rsp:SearchProfile]]'
    >
      <semantic-search-query-builder
        id="semantic-query-builder"
        relation-template=' <div style="margin-left: {{order.value}}px">{{label}}</div> '
        resource-selector='[[> rsp:SearchResourceSelector]]'
        tree-selector='[[> rsp:SearchTreeSelector]]'
        geo-selector='[[> rsp:SearchGeoSelector]]'
      >
      </semantic-search-query-builder>
      <div data-flex-layout="row stretch-stretch">
        <div data-flex-self="size-1of3" style="flex: 0 0 0">
          <semantic-search-facet
            id="semantic-search-facet"
            value-categories='[[> rsp:SearchValueCategories]]'
          ></semantic-search-facet>
        </div>
        <semantic-search-result-holder>
          <div data-flex-self="md-full">
            <semantic-search-facet-breadcrumbs></semantic-search-facet-breadcrumbs>
            <semantic-search-result id="semantic-search-result">
              <mp-sparql-result-counts
                id="semantic-search-result-count"
                query="SELECT DISTINCT ?subject {}"
                template="{{> template}}"
              >
                <template id="template">
                  {{#if hasLimit}}
                  <bs-alert bs-style="warning" class="search-results__alert">
                    <i
                      class="fa fa-exclamation-triangle"
                      aria-hidden="true"
                    ></i>
                    <span class="num-results"
                      >Found {{numberOfResults}} matches</span
                    >
                    of {{totalNumberOfResults}} matches.
                    <strong>Please, refine your search.</strong>
                  </bs-alert>
                  {{else}}
                  <span class="num-results"
                    >Found {{numberOfResults}} matches</span
                  >
                  {{/if}}
                </template>
              </mp-sparql-result-counts>
            </semantic-search-result>
            <bs-tabs
              default-active-key="1"
              unmount-on-exit="true"
              id="search-results"
              animation="false"
              class="tabs-right"
            >
              <bs-tab event-key="1" title="Cards">
             
             <!-- //TODO check time -->
                <semantic-search-result>
                   <!-- Table of Cards -->
                   <semantic-table
                   id="grid-result"
                   options='{
                         "showFilter":false
                       }'
                   number-of-displayed-rows="10"
                   query='
                   SELECT DISTINCT ?subject (GROUP_CONCAT(STR(?subjects);SEPARATOR=" , ") AS ?originalSubject)
                   WHERE {
                             {  
                               ?subjects owl:sameAs ?subject.
                             } UNION {
                               ?subject a <https://pharos.artresearch.net/resource/fc/subject>.
                             } UNION {
                               ?subject a <https://pharos.artresearch.net/resource/fc/photo>.
                             } UNION {
                              ?subject a <https://pharos.artresearch.net/resource/fc/material>.
                             }
                      }GROUP BY(?subject) LIMIT 100'
                   tuple-template="{{>tupleTemplate}}"
                 >
                 
                   <template id="tupleTemplate">
                     <semantic-link iri="{{subject.value}}">
                      <mp-draggable iri="{{subject.value}}">
                        [[> rsp:artworkCardCombined]]
                      </mp-draggable>
                    </semantic-link>
                   </template>
                 </semantic-table>
                </semantic-search-result>
              </bs-tab>
              <bs-tab event-key="2" title="Tabular">
                <div id="tableView">
                <semantic-search-result>
                  <semantic-table
                    id="semantic-search-result-table"
                    query="SELECT DISTINCT ?subject ?creator ?date ?repository ?provider WHERE {
                      # Artworks
                        OPTIONAL{
                          ?subject <https://pharos.artresearch.net/resource/fr/Work_created_from_Artist> ?creator.
                        }
                        OPTIONAL{
                          ?subject <https://pharos.artresearch.net/resource/fr/Work_from_Date> ?date.
                        }
                        OPTIONAL{
                          ?subject <https://pharos.artresearch.net/resource/fr/Work_kept_by_Institution> ?repository.
                        }
                        OPTIONAL{
                          ?subject <https://pharos.artresearch.net/resource/fr/Work_has_provider_Institution> ?provider.
                        }
                        ?subject a <https://pharos.artresearch.net/resource/fc/work>.
                        #TODO UNIONS for artists & photographers  ?
                    }LIMIT 100"
                    options='{"showFilter":true, "resultsPerPage":10}'
                    column-configuration='[
                    {"variableName": "subject", "displayName": "Title"},
                    {"variableName": "date", "displayName": "Date"},
                    {"variableName": "creator", "displayName": "Creator"},
                    {"variableName": "repository", "displayName": "Repository"},
                    {"variableName": "provider", "displayName": "Provider"}
                    ]'
                  >
                  </semantic-table>
                  <semantic-table
                  id="semantic-search-result-table"
                  query="SELECT DISTINCT ?subject ?creator ?date ?repository ?provider WHERE {
                    # Photographs
                      
                    OPTIONAL{
                      ?work <https://pharos.artresearch.net/resource/fr/Work_depicted_by_Photo> ?subject.
                    }
                    OPTIONAL{
                      ?work    <https://pharos.artresearch.net/resource/fr/Work_depicted_by_Photo> ?subject.
                      ?work <https://pharos.artresearch.net/resource/fr/Work_created_from_Artist> ?creator.
                    }
                    OPTIONAL{
                      ?subject <https://pharos.artresearch.net/resource/fr/Photo_kept_by_Institution> ?repository.
                    }
                    OPTIONAL{
                      ?subject <https://pharos.artresearch.net/resource/fr/Photo_has_provider_Institution> ?provider.
                    }
                    ?subject a <https://pharos.artresearch.net/resource/fc/photo>.
                  }LIMIT 100"
                  options='{"showFilter":true, "resultsPerPage":10}'
                  column-configuration='[
                  {"variableName": "subject", "displayName": "Title"},
                  {"variableName": "date", "displayName": "Date"},
                  {"variableName": "creator", "displayName": "Creator"},
                  {"variableName": "repository", "displayName": "Repository"},
                  {"variableName": "provider", "displayName": "Provider"}
                  ]'
                >
                </semantic-table>
                </semantic-search-result>
              </div>
              </bs-tab>
              <bs-tab event-key="3" title="Chart">
                <semantic-search-result-context
                  ranges='["http://www.researchspace.org/ontology/Concept", "http://www.researchspace.org/ontology/Place", "http://www.researchspace.org/ontology/Actor"]'
                >
                  <semantic-search-result id="semantic-search-result-chart">
                    <mp-component-toolbar>
                      <mp-component-toolbar-actions>
                        <semantic-chart-type-selector
                          id="search-result-chart-type-selector"
                          default="bar"
                          types='["line", "bar", "radar", "pie", "donut"]'
                          style="margin-right: 10px"
                        ></semantic-chart-type-selector>
                        <mp-component-toolbar-action-download></mp-component-toolbar-action-download>
                        <mp-component-toolbar-action-save
                          id="persit-component-action"
                          add-to-default-set="true"
                        ></mp-component-toolbar-action-save>
                      </mp-component-toolbar-actions>
                      <mp-component-toolbar-component>
                        <semantic-chart
                          id="search-result-chart"
                          query='
                                             SELECT ?object (COUNT(DISTINCT ?subject) as ?count) WHERE {
                                               OPTIONAL { ?subject ?__contextRelation__ ?object }
                                               BIND(IF(BOUND(?object), ?object, "Unknown") as ?object)
                                             } GROUP BY ?object ORDER BY DESC(?count)
                                             '
                          sets='[{
                                              "category": "object",
                                              "value": "count"
                                            }]'
                        >
                        </semantic-chart>
                      </mp-component-toolbar-component>
                    </mp-component-toolbar>
                  </semantic-search-result>
                </semantic-search-result-context>
              </bs-tab>
              <bs-tab event-key="4" title="Timeline">
                <div>
                  <semantic-search-result>
                    <mp-sparql-result-counts
                      id="timeline-search-result-count"
                      query="SELECT DISTINCT ?subject {} LIMIT 100"
                      template="{{> template}}"
                    >
                      <template id="template">
                        {{#if hasLimit}}
                        <bs-alert
                          bs-style="warning"
                          class="search-results__alert"
                        >
                          <i
                            class="fa fa-exclamation-triangle"
                            aria-hidden="true"
                          ></i>
                          <span class="num-results">
                            There were {{totalNumberOfResults}} results. Only
                            100 can be visualised on the timeline at once!
                          </span>
                        </bs-alert>
                        {{/if}}
                      </template>
                    </mp-sparql-result-counts>
                  </semantic-search-result>

                  <semantic-search-result-context
                    ranges='["http://www.researchspace.org/ontology/Time"]'
                  >
                    <semantic-search-result>
                      <mp-component-toolbar>
                        <mp-component-toolbar-actions>
                          <mp-component-toolbar-action-save
                            id="persit-component-action"
                            add-to-default-set="true"
                          ></mp-component-toolbar-action-save>
                        </mp-component-toolbar-actions>
                        <mp-component-toolbar-component>
                          <semantic-timeline
                            id="search-result-timeline"
                            query="PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                                 SELECT DISTINCT ?start ?end ?iri WHERE {
                                    FILTER(?__contextRelationPattern__)
                                    BIND(?__dateBeginValue__ AS ?start)
                                    BIND(?__dateEndValue__ AS ?end)
                                    BIND(?subject as ?iri) .
                                 }
                                 ORDER BY ?subject
                                 LIMIT 100
                                 "
                            tuple-template="{{> timelineItem}}"
                            tuple-template-height="50"
                          >
                            <template id="timelineItem">
                              <mp-popover>
                                <mp-popover-trigger
                                  placement="top"
                                  trigger='["hover"]'
                                  root-close="false"
                                >
                                  <div data-flex-layout="column top-left">
                                    <p>{{start.value}} - {{end.value}}</p>
                                    <semantic-link
                                      iri="{{iri.value}}"
                                    ></semantic-link>
                                  </div>
                                </mp-popover-trigger>
                                <mp-popover-content
                                  >{{>
                                  rsp:itemCardTemplate}}</mp-popover-content
                                >
                              </mp-popover>
                            </template>
                          </semantic-timeline>
                        </mp-component-toolbar-component>
                      </mp-component-toolbar>
                    </semantic-search-result>
                  </semantic-search-result-context>
                </div>
              </bs-tab>
            </bs-tabs>

            <hr />
            <div
              class="semantic-search-results-actions pull-right"
              style="display: flex"
            >
              <semantic-search-result>
                <mp-sparql-download
                  id="csv-result"
                  query="SELECT ?subject WHERE { }"
                  header="text/csv"
                  filename="csv-result.csv"
                >
                  <button class="btn btn-default" style="margin-right: 10px">
                    Download CSV
                  </button>
                </mp-sparql-download>
              </semantic-search-result>
              <semantic-search-result>
                <mp-sparql-download
                  id="json-result"
                  query="SELECT ?subject WHERE { }"
                  header="application/sparql-results+json"
                  filename="json-result.json"
                >
                  <button class="btn btn-default" style="margin-right: 10px">
                    Download JSON
                  </button>
                </mp-sparql-download>
              </semantic-search-result>
              <semantic-search-action-use-result-in-extended-search>
                <button class="btn btn-default" style="margin-right: 10px">
                  Use in Search
                </button>
              </semantic-search-action-use-result-in-extended-search>
              <mp-anonymous-hidden>
                <semantic-search-action-save-set-result
                  id="save-set-result-action"
                >
                  <button class="btn btn-default" style="margin-right: 10px">
                    Save As Set
                  </button>
                </semantic-search-action-save-set-result>
              </mp-anonymous-hidden>
              <mp-anonymous-hidden>
                <semantic-search-action-save-search-result
                  id="save-search-result-action"
                  add-to-default-set="true"
                >
                  <button class="btn btn-default" style="margin-right: 10px">
                    Save As Search
                  </button>
                </semantic-search-action-save-search-result>
              </mp-anonymous-hidden>
            </div>
          </div>
        </semantic-search-result-holder>
      </div>
    </semantic-search>
  </div>
  [[/rsp:ClipboardSidebar]]
</div>
</div>